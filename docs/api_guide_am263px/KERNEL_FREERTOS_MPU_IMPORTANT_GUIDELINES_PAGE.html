<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263Px MCU+ SDK: FreeRTOS MPU usage guidelines</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263Px MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263Px MCU+ SDK
   &#160;<span id="projectnumber">11.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('KERNEL_FREERTOS_MPU_IMPORTANT_GUIDELINES_PAGE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">FreeRTOS MPU usage guidelines </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md748">Using and adding FreeRTOS MPU to your project</a></li>
<li class="level1"><a href="#autotoc_md749">Important tips for application writers</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_components_kernel_os_freertos_mpu_important_guidelines"></a></p>
<p>This section has additional useful information related to FreeRTOS MPU and its integration within MCU+ SDK.</p>
<p>Refer <a href="https://www.freertos.org/Security/04-FreeRTOS-MPU-memory-protection-unit">FreeRTOS - Memory Protection Unit (MPU) Support</a> for official FreeRTOS documentation.</p>
<h1><a class="anchor" id="autotoc_md748"></a>
Using and adding FreeRTOS MPU to your project</h1>
<ul>
<li>You can start using FreeRTOS MPU referring to <a class="el" href="EXAMPLES_KERNEL_FREERTOS_TASK_SWITCH_MPU.html">FreeRTOS MPU Task Switch Example</a> at <code>${SDK_INSTALL_PATH}/examples/kernel/freertos/task_switch_mpu</code></li>
<li>Also refer <a class="el" href="EXAMPLES_KERNEL_DPL_DEMO.html">Driver Porting Layer (DPL) demo</a> at <code>examples/kernel/dpl/dpl_demo</code> for usage of DPL TaskP API to create user mode tasks.</li>
<li>Given below are some details to add FreeRTOS MPU to a project if you decide to start from scratch</li>
<li>Below paths must be added to your project include path to use FreeRTOS Kernel API with MPU support <pre class="fragment">  ${MCU_PLUS_SDK_PATH}/source/kernel/freertos/FreeRTOS-Kernel/include
  ${MCU_PLUS_SDK_PATH}/source/kernel/freertos/portable/TI_ARM_CLANG/ARM_CR5F_MPU
  ${MCU_PLUS_SDK_PATH}/source/kernel/freertos/config/am263px/r5f_mpu
</pre></li>
<li>To link to FreeRTOS library, add below path to you library path <pre class="fragment">  ${MCU_PLUS_SDK_PATH}/source/kernel/freertos/lib
</pre></li>
<li>And link to below library for your SOC and CPU of choice <pre class="fragment">  freertos.{soc}.{cpu}-mpu.{compiler}.{profile}.lib
</pre></li>
</ul>
<h1><a class="anchor" id="autotoc_md749"></a>
Important tips for application writers</h1>
<ul>
<li>For R5F with total of 16 configurable MPU regions,<ul>
<li>The first 8 regions (Region 0 - Region 7) are static and can be setup via SysConfig<ul>
<li>SysConfig generates DPL MpuP config and these are programmed one-time as part of startup code</li>
</ul>
</li>
<li>Next region is reserved for task stack (Region 8)<ul>
<li>Refer <a href="https://www.freertos.org/Documentation/02-Kernel/04-API-references/13-FreeRTOS-MPU-specific/02-xTaskCreateRestrictedStatic"><code>xTaskCreateRestrictedStatic</code></a> API documentation description for <code>puxStackBuffer</code> for details on various constraints related to stack size and alignment</li>
</ul>
</li>
<li>Rest of the 7 regions (Region 9 - Region 15) are task specific and can be provided while creating the task</li>
</ul>
</li>
<li>Various FreeRTOS kernel APIS like create/delete tasks/semaphore/events can be used only from privileged tasks and are not available for user mode tasks<ul>
<li>Refer <b>System Call restrictions</b> under "Changes in FreeRTOS version 10.6.0" and "Changes in FreeRTOS version 10.5.0" in <a href="https://www.freertos.org/Security/04-FreeRTOS-MPU-memory-protection-unit#upgrade-information">FreeRTOS - Memory Protection Unit (MPU) Support - Upgrade Information</a> for the list of APIs that are not accessible from user mode tasks</li>
<li>Hence following DPL APIs which are implemented using these restricted kernel APIs should as well be used only from a privileged task,<ul>
<li><code>TaskP_construct</code></li>
<li><code>TaskP_constructRestricted</code></li>
<li><code>TaskP_destruct</code></li>
<li><code>SemaphoreP_constructMutex</code></li>
<li><code>SemaphoreP_constructBinary</code></li>
<li><code>SemaphoreP_constructCounting</code></li>
<li><code>SemaphoreP_destruct</code></li>
<li><code>MailboxP_create</code></li>
<li><code>MailboxP_delete</code></li>
<li><code>EventP_construct</code></li>
<li><code>EventP_destruct</code></li>
<li><code>ClockP_construct</code></li>
<li><code>TaskP_loadGet</code></li>
<li><code>TaskP_loadGetTotalCpuLoad</code></li>
<li><code>TaskP_loadUpdateAll</code></li>
<li><code>TaskP_loadResetAll</code></li>
<li><code>HeapP_construct</code></li>
<li><code>HeapP_destruct</code></li>
</ul>
</li>
</ul>
</li>
<li>RTI registers are read-only in user mode and can be modified only in privileged mode.<ul>
<li>Hence various SDK APIs which are impacted due to this performs temporary switch to privileged mode when invoked from user mode tasks. This is similar to how FreeRTOS kernel system calls are implemented for user mode tasks. Following are the list of SDK APIs,<ul>
<li><code>TimerP_setup</code></li>
<li><code>TimerP_start</code></li>
<li><code>TimerP_stop</code></li>
<li><code>TimerP_clearOverflowInt</code></li>
</ul>
</li>
</ul>
</li>
<li>Performance monitoring registers in Cortex-R5 will be accessible in user mode only if <a href="https://developer.arm.com/documentation/ddi0460/d/Events-and-Performance-Monitor/Performance-monitoring-registers/c9--User-Enable-Register?lang=en"><code>c9, User Enable Register</code></a> <code>EN</code> bit is set. This needs to be set from privileged mode.<ul>
<li>Hence SDK sets this as part of starting the scheduler before switching to the first task. This enables user mode tasks to access the PMU registers as well as use various DPL <code>CycleCounterP</code> APIs (<a class="el" href="group__KERNEL__DPL__CYCLE__COUNTER.html">APIs for Counting CPU Cycles</a>)</li>
</ul>
</li>
<li>While creating the first task for an application that uses FreeRTOS MPU, make sure to create in privileged mode so as to be able to create other tasks, semaphores, etc.</li>
<li>A privileged task is created by performing a bitwise OR of <code>portPRIVILEGE_BIT</code> with the task priority parameter of <code>xTaskCreateStatic</code><ul>
<li>Refer <a href="https://www.freertos.org/Documentation/02-Kernel/04-API-references/01-Task-creation/02-xTaskCreateStatic"><code>xTaskCreateStatic</code></a> API documentation description for <code>uxPriority</code> parameter for more details</li>
</ul>
</li>
<li>A user mode task with task specific MPU regions is created using <a href="https://www.freertos.org/Documentation/02-Kernel/04-API-references/13-FreeRTOS-MPU-specific/02-xTaskCreateRestrictedStatic"><code>xTaskCreateRestrictedStatic</code></a></li>
<li>Refer <a href="https://www.freertos.org/Security/04-FreeRTOS-MPU-memory-protection-unit#creating-tasks">FreeeRTOS - Memory Protection Unit (MPU) Support - Creating Tasks</a> for more details</li>
<li>DPL API <code>TaskP_construct</code> can be used to create privileged tasks whereas <code>TaskP_constructRestricted</code> can be used to create user mode task with task specific MPU regions<ul>
<li><code>TaskP_constructRestricted</code> API uses DPL MpuP structure <code><a class="el" href="structMpuP__RegionAttrs.html" title="Attribute&#39;s to apply for a MPU region.">MpuP_RegionAttrs</a></code> to define the region attributes for the task specific MPU regions, similar to how the static MPU regions are configured </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
