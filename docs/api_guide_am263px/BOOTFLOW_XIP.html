<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263Px MCU+ SDK: Enabling XIP or eXecute In Place</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263Px MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263Px MCU+ SDK
   &#160;<span id="projectnumber">11.02.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('BOOTFLOW_XIP.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Enabling XIP or eXecute In Place </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md427">Introduction</a></li>
<li class="level1"><a href="#autotoc_md428">Additional References</a></li>
<li class="level1"><a href="#autotoc_md429">Pre-requisites</a></li>
<li class="level1"><a href="#autotoc_md430">Enable XIP for an application</a><ul><li class="level2"><a href="#autotoc_md431">Using linker.cmd</a></li>
<li class="level2"><a href="#autotoc_md432">Using Memory Configurator</a><ul><li class="level3"><a href="#autotoc_md433">Moving .rodata and .text to flash</a></li>
<li class="level3"><a href="#autotoc_md434">Moving cfg rodata to internal memory</a></li>
<li class="level3"><a href="#autotoc_md435">Moving CIO to internal memory</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md436">Enabling secure XIP using OTFA</a><ul><li class="level2"><a href="#autotoc_md437">Steps enable security in XIP image,</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md438">Debugging XIP applications</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_developer_guides_bootflow_xip"></a></p>
<h1><a class="anchor" id="autotoc_md427"></a>
Introduction</h1>
<ul>
<li>Normally, when running a application, the application code is first copied to RAM by bootloader and then code executes from RAM.</li>
<li>XIP or eXecute In Place allows a application to execute part of the code from flash without having to copy to RAM.</li>
<li>Advantage is, this allows users to have a larger code size limited by flash size rather than limited by RAM size.</li>
<li>Disadvantage is,<ul>
<li>The flash memory is typically slower (~300MB/s bandwidth) vs RAM memory ( &gt; 1600 MB/s),</li>
<li>Due to this, execution speed, esp when code is not cached in the CPU cache, will be slower as compared to when executing from RAM.</li>
</ul>
</li>
<li>However in some situations it is needed to execute code from flash for non-real time, non high performance code.</li>
<li>XIP allows to do this.</li>
</ul>
<h1><a class="anchor" id="autotoc_md428"></a>
Additional References</h1>
<p>See also these additional pages for more details and examples about XIP,</p>
<ul>
<li>To understand and run a example in XIP mode see<ul>
<li><a class="el" href="BENCHMARK_SMART_PLACEMENT.html#BENCHMARK_SMART_PLACEMENT_COMBOS">Supported Combinations</a></li>
</ul>
</li>
<li>To understand overall boot flow see, <a class="el" href="BOOTFLOW_GUIDE.html">Understanding the bootflow and bootloaders</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md429"></a>
Pre-requisites</h1>
<ul>
<li>The flash memory should be visible to the CPU, in "direct access mode (DAC)" i.e memory mapped mode.<ul>
<li>Here the contents of the flash can be read as any other memory region.</li>
<li>This typically is a "read-only" memory</li>
</ul>
</li>
<li>The secondary bootloader needs to enable flash at highest throughput mode in this DAC mode, before booting the application.</li>
<li>The application entry point, interrupt vectors and initial code upto <code>main()</code> should still execute from RAM. After <code>main()</code> the code can execute from flash.</li>
</ul>
<h1><a class="anchor" id="autotoc_md430"></a>
Enable XIP for an application</h1>
<h2><a class="anchor" id="autotoc_md431"></a>
Using linker.cmd</h2>
<p>To enable XIP for a application, below changes need to be done,</p>
<ul>
<li>Enable cache for the XIP flash region. This is need to get better performance for the XIP execution<ul>
<li>On R5F, this is done by adding a MPU entry for region <code>0x60000000</code> of size 256MB. This can be done via SysConfig.</li>
<li>If a CPU, say M4F, does not have any cache, then recommend to not use XIP for that CPU.</li>
<li>A sample MPU setting on AM64x, AM243x SOC done via SysConfig is shown below.<ul>
<li>Make sure to enable code execution, and cache for this region.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p> <style>div.image img[src="bootflow_xip_mpu_setup.png"]{width:60%}</style> </p><div class="image">
<img src="bootflow_xip_mpu_setup.png" alt=""/>
<div class="caption">
Flash section in R5F MPU</div></div>
<ul>
<li>Update the linker command file to re-direct required <code>.text</code> and <code>.rodata</code> sections to <code>FLASH</code> region as shown below <div class="fragment"><div class="line">SECTIONS {</div>
<div class="line">    ...</div>
<div class="line">    GROUP {</div>
<div class="line">        .text.hwi: palign(8)</div>
<div class="line">        .text.cache: palign(8)</div>
<div class="line">        .text.mpu: palign(8)</div>
<div class="line">        .text.boot: palign(8)</div>
<div class="line">        .text.main: palign(8) /*  this helps ccs to put breakpoint at main */</div>
<div class="line">        .text:abort: palign(8) /* this helps in loading symbols when using XIP mode */</div>
<div class="line">    } &gt; MSRAM</div>
<div class="line"> </div>
<div class="line">    cio &gt; MSRAM</div>
<div class="line">    {</div>
<div class="line">        -llibsysbm.a&lt;trgmsg.c.obj&gt; (.text)</div>
<div class="line">    }</div>
<div class="line">    ...</div>
<div class="line">    GROUP {</div>
<div class="line">        .text:   {} palign(8)   /* This is where code resides */</div>
<div class="line">        .rodata: {} palign(8)   /* This is where const&#39;s go */</div>
<div class="line">    } &gt; FLASH</div>
<div class="line">    ...</div>
<div class="line">    GROUP {</div>
<div class="line">        .rodata.cfg: {} palign(8)   /* MPU configurations */</div>
<div class="line">    } &gt; MSRAM</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">MEMORY</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    FLASH     : ORIGIN = 0x60100000 , LENGTH = 0x80000</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>When printing logs, CCS utilizes CIO breakpoints. For loading and running XIP .out from CCS, it's essential to keep -llibsysbm.a&lt;trgmsg.c.obj&gt; (.text) inside MSRAM. Additionally, ensure that the main symbol is also kept in the MSRAM because CCS uses it to halt the core at the main when loading the .out.</li>
<li>The same process can be repeated for multiple CPUs if needed, only make sure the <code>FLASH</code> defined in <code>MEMORY { ... }</code> for the linker command files of each CPU are non-overlapping.</li>
<li><b>NOTE</b>, when multiple CPUs run using XIP, the overall available flash bandwidth get split across multi-CPUs. So the overall performance will degrade vs using single CPU in XIP mode. However, functionally nothing restricts such a mode of operation.</li>
<li>As part of post build step, one extra step is run as compared to non-XIP case, as listed below<ul>
<li><code>xipGen</code> tool is used to split the application into non-XIP and XIP sections</li>
</ul>
</li>
<li>The file containing XIP sections is additionally flashed to the flash using the special <code>flash-xip</code> command passed to the flash writer</li>
<li><b>NOTE</b>, the secondary bootloader remains exactly the same when running applications in XIP or non-XIP mode.</li>
<li>For all the SDK examples<ul>
<li>The linker command is updated to include the <code>FLASH</code> memory segment. The code/rodata section are NOT re-directed to FLASH by default though, unless mentioned otherwise in the example.</li>
<li>XIP post-build steps are always invoked as part of application post build. Invoking these steps even though there is no XIP section has no side effect.</li>
<li>The default flash writer config file has the flashing command needed to flash the XIP sections. Again, if XIP sections are not present there is no side effect on normal non-XIP operation.</li>
</ul>
</li>
<li>Thus, all one needs to do to enable XIP is<ul>
<li>Add a MPU/MMU entry to mark the flash region as executable + cached</li>
<li>And update the linker command to mark the code/rodata sections as <code>FLASH</code> instead of RAM.</li>
<li>Rest of the steps remain exactly the same as non-XIP case.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md432"></a>
Using Memory Configurator</h2>
<h3><a class="anchor" id="autotoc_md433"></a>
Moving .rodata and .text to flash</h3>
<p>As mentioned in the previous section, move <b><code>.rodata</code></b> and <b><code>.text</code></b> in external flash, as shown in the following image:</p>
<p> <style>div.image img[src="enabling_xip_mem_configurator_1.png"]{width:80%}</style> </p><div class="image">
<img src="enabling_xip_mem_configurator_1.png" alt=""/>
<div class="caption">
Moving text and rodata to flash.</div></div>
<p>Here load and run memory, both are set to FLASH memory.</p>
<p>Make sure that <b><code>Alignment with padding</code></b> checkbox has been checked.</p>
<h3><a class="anchor" id="autotoc_md434"></a>
Moving cfg rodata to internal memory</h3>
<p>Then, it is required to move <b><code>.rodata.cfg</code></b> in the internal memory. For this, refer to the following image:</p>
<p> <style>div.image img[src="enabling_xip_mem_configurator_2.png"]{width:80%}</style> </p><div class="image">
<img src="enabling_xip_mem_configurator_2.png" alt=""/>
<div class="caption">
Moving cfg rodata to internal memory.</div></div>
<p>Here, <b><code>.cfg.rodata</code></b> output section has been added in <b><code>Text Segments</code></b> group.</p>
<p>Make sure that <b> <code>Alignment with padding</code> </b> checkbox has been checked.</p>
<h3><a class="anchor" id="autotoc_md435"></a>
Moving CIO to internal memory</h3>
<p>Refer to following image:</p>
<p> <style>div.image img[src="enabling_xip_mem_configurator_3.png"]{width:80%}</style> </p><div class="image">
<img src="enabling_xip_mem_configurator_3.png" alt=""/>
<div class="caption">
Moving CIO to internal memory.</div></div>
<ol type="1">
<li>add <b><code>cio</code></b> output section to <b><code>Text Segments</code></b> group.</li>
<li>Make sure that <b><code>Alignment with padding</code></b> checkbox has been checked.</li>
<li>Add <b><code>-llibsysbm.a&lt;trgmsg.c.obj&gt; (.text)</code></b> as the input section</li>
</ol>
<p>With the above, this will direct cio library in internal memory.</p>
<p>This step is required if CCS logs are enabled. In production build, CCS logs should be disabled.</p>
<h1><a class="anchor" id="autotoc_md436"></a>
Enabling secure XIP using OTFA</h1>
<dl class="section note"><dt>Note</dt><dd>This feature is only valid for HSSE device.</dd></dl>
<ul>
<li>Applications stored in external flash are susceptible to physical and logical attacks. Ensuring the security and safety of the image executed in place is important to achieve advanced security for the device.</li>
<li>Signing and encrypting application image to be executed from flash enables this. AM263PX is equipped with OTFA (On-The-Fly-Authentication and Decryption) hardware module to authenticate and decrypt an application running from flash.</li>
<li>OTFA can be configured to authenticate and decrypt up to four distinct regions in the flash, with different keys. The key management for OTFA is expected to be done by HSM Run Time Firmware.</li>
<li>The application binary, converted to MCELF format is post-processed for safety and security using the <b>genimage.py</b> tool [Refer <a class="el" href="TOOLS_BOOT.html">Booting Tools</a>]</li>
</ul>
<h2><a class="anchor" id="autotoc_md437"></a>
Steps enable security in XIP image,</h2>
<ol type="1">
<li>Enter the OTFA configuration settings in JSON format as shown in the example json file below: <div class="fragment"><div class="line">{</div>
<div class="line">&quot;mac_size&quot;: 4,</div>
<div class="line">&quot;regions&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;start&quot;: &quot;0x60000000&quot;,</div>
<div class="line">        &quot;size&quot;: &quot;0x1000000&quot;,</div>
<div class="line">        &quot;authKeyID&quot; : 1,</div>
<div class="line">        &quot;authKey&quot;: Absolute path to key For example: &quot;/home/user/ti/mcu_plus_sdk/source/security/security_common/tools/boot/signing/mcu_custMek.key&quot;,</div>
<div class="line">        &quot;encKeyID&quot; : 1,</div>
<div class="line">        &quot;encKey&quot;: Absolute path to key For example: &quot;/home/user/ti/mcu_plus_sdk/source/security/security_common/tools/boot/signing/mcu_custMek.key&quot;,</div>
<div class="line">        &quot;kdSalt&quot; : Absolute path to salt For example: &quot;/home/user/ti/mcu_plus_sdk/source/security/security_common/tools/boot/signing/kd_salt.txt&quot;,</div>
<div class="line">        &quot;keyFetchMode&quot; : 1,            </div>
<div class="line">        &quot;cryptoMode&quot;:&quot;gcm&quot;,</div>
<div class="line">        &quot;eccEnable&quot;: false</div>
<div class="line">    }</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>KeyIDs correspond to the indices of the keys in Keyring which will be provided to the HSM Run Time Firmware via <b>HsmClient_Config</b> for authentication and decryption and used by <b>HsmServer</b> for authentication and decryption.<ul>
<li>If KeyID = 1/3 (SMEK or BMEK), the root key is used to encrypt the image in the flash. This is the same key which is used to encrypt the SBL as well as HSM Run Time firmware.</li>
<li>If KeyID &gt;= 32, auxilary key is used for encryption. This key is retrieved from the keyring which is managed by the HSM Run Time Firmware.</li>
<li>Example JSON Path : mcu_plus_sdk/tools/boot/otfa_eccm/otfaConf.json</li>
</ul>
</li>
</ul>
</li>
<li>Build the application image with the above JSON file as a tool input<ul>
<li>Example : <div class="fragment"><div class="line">make -s DEVICE=am263px DEVICE_TYPE=HS oeconfig=mcu_plus_sdk/tools/boot/otfa_eccm/otfaConf.json all</div>
</div><!-- fragment --></li>
<li>This generates<ul>
<li>a post-processed MCELF_XIP image, encrypted and authenticated with the same root key key which is used to encrypt the SBL as well as HSM Run Time firmware.</li>
<li>a note-appended MCELF_RAM image, that contains the OTFA configuration parameters' details.</li>
</ul>
</li>
</ul>
</li>
<li>Build the uart_uniflash SBL<ul>
<li>Example : <div class="fragment"><div class="line">make -s examples/drivers/boot/sbl_uart_uniflash/am263px/r5fss0-0_nortos/ti-arm-clang DEVICE=am263px DEVICE_TYPE=HS all</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Build the any sbl_ospi (ex. sbl_ospi_multicore_elf) SBL<ul>
<li>Example : <div class="fragment"><div class="line">make -s examples/drivers/boot/sbl_ospi_multicore_elf/am263px/r5fss0-0_nortos/ti-arm-clang DEVICE=am263px DEVICE_TYPE=HS all</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>In order to flash the image using uart_uniflash.py tool, we first need to configure the mcelf_sbl_ospi.cfg. Change the path of the images to the appropriate path. <div class="fragment"><div class="line">#-----------------------------------------------------------------------------#</div>
<div class="line">#                                                                             #</div>
<div class="line">#      DEFAULT CONFIGURATION FILE TO BE USED WITH THE FLASHWRITER SCRIPT      #</div>
<div class="line">#                                                                             #</div>
<div class="line">#-----------------------------------------------------------------------------#</div>
<div class="line">#</div>
<div class="line"># By default this config file,</div>
<div class="line"># - points to pre-built flash writer, bootloader for this EVM</div>
<div class="line"># - The application image points to relative path of the ipc echo application image for this EVM</div>
<div class="line">#   - Make sure this application is built before running this script</div>
<div class="line"># - You can customized this config file to point to your own bootloader and/or application images</div>
<div class="line"># - You can use --operation=flashverify if you just want to verify the flash contents and not flash the file.</div>
<div class="line">#</div>
<div class="line"> </div>
<div class="line"># First point to sbl_uart_uniflash binary, which function&#39;s as a server to flash one or more files</div>
<div class="line">--flash-writer=(PATH TO)/sbl_uart_uniflash.release.hs.tiimage</div>
<div class="line"> </div>
<div class="line"># Program the OSPI PHY tuning attack vector</div>
<div class="line">--operation=flash-phy-tuning-data</div>
<div class="line"> </div>
<div class="line"># When sending bootloader make sure to flash at offset 0x0. ROM expects bootloader at offset 0x0</div>
<div class="line">--file=(PATH TO)/sbl_ospi_multicore_elf.release.hs.tiimage --operation=flash --flash-offset=0x0</div>
<div class="line"> </div>
<div class="line"># When sending application image, make sure to flash at offset 0x81000 (default) or to whatever offset your bootloader is configured for</div>
<div class="line">--file= (PATH TO)release.mcelf.hs --operation=flash-sector-write --flash-offset=0x81000</div>
<div class="line"> </div>
<div class="line"># send the XIP image for this application, no need to specify flash offset since flash offset is specified within the image itself</div>
<div class="line">--file=(PATH TO)release.mcelf_xip --operation=flash-mcelf-xip</div>
</div><!-- fragment --></li>
<li>Change the boot mode to UART and flash the images using the following command. <div class="fragment"><div class="line">cd ~/ti/mcu_plus_sdk/tools/boot/</div>
<div class="line">python3 uart_uniflash.py -p /dev/ttyUSB&lt;xx&gt; --cfg=sbl_prebuilt/am263px-cc/default_sbl_ospi.cfg</div>
</div><!-- fragment --> Once the images are flashed switch to OSPI boot mode and reset device to see the output.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>In order to use auxilary keys for encryption, please check the TIFS documentation for auxilary key usage. For encryption using auxilary keys, a keyring certificate needs to be generated. This certificate contains the key and has to be imported in the SBL build.</dd></dl>
<h1><a class="anchor" id="autotoc_md438"></a>
Debugging XIP applications</h1>
<ul>
<li>XIP applications can not be loaded via CCS, hence to debug a XIP application one needs to always flash and run the application and then "load symbols" via CCS to debug the application</li>
<li>Another alternative is develop and debug the application with all code in "RAM" and then just update the linker command to use "FLASH" and do the final test or debug with application in XIP mode.</li>
<li>The CCS option to load symbols is shown below,</li>
</ul>
<p> <style>div.image img[src="bootflow_xip_load_symbols.png"]{width:60%}</style> </p><div class="image">
<img src="bootflow_xip_load_symbols.png" alt=""/>
<div class="caption">
CCS Load Symbols</div></div>
<ul>
<li>Normal "SW" breakpoints in CCS wont work for code in flash, and "HW" breakpoints should be used.<ul>
<li>To put a breakpoint CCS needs to write a special instruction at the point in code,</li>
<li>However since the flash memory is "read-only", this will result in a error, hence one should use "HW" breakpoints instead</li>
</ul>
</li>
<li>Below shows a example of putting a HW breakpoint,</li>
</ul>
<p> <style>div.image img[src="bootflow_xip_hw_break_point.png"]{width:60%}</style> </p><div class="image">
<img src="bootflow_xip_hw_break_point.png" alt=""/>
<div class="caption">
HW Breakpoint</div></div>
<ul>
<li>When prompted enter the function name on which you want the breakpoint to hit. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
