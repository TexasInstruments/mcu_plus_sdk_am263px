<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263Px MCU+ SDK: FreeRTOS MPU Task Switch Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263Px MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263Px MCU+ SDK
   &#160;<span id="projectnumber">11.00.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLES_KERNEL_FREERTOS_TASK_SWITCH_MPU.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">FreeRTOS MPU Task Switch Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1590">Introduction</a></li>
<li class="level1"><a href="#autotoc_md1591">Supported Combinations</a></li>
<li class="level1"><a href="#autotoc_md1592">Steps to Run the Example</a></li>
<li class="level1"><a href="#autotoc_md1593">See Also</a></li>
<li class="level1"><a href="#autotoc_md1594">Sample Output</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_kernel_freertos_task_switch_mpu"></a></p>
<h1><a class="anchor" id="autotoc_md1590"></a>
Introduction</h1>
<p>This example shows usage of direct FreeRTOS APIs, i.e not via the DPL APIs. It shows usage of user mode task create API, task notification APIs, semaphore APIs. It also shows how to signal to FreeRTOS task from ISRs.</p>
<p>The example does below:-</p><ul>
<li>Creates two user mode tasks, ping and pong with task specific MPU regions</li>
<li>Creates three semaphores</li>
<li>Ping and pong tasks signal each other using semaphores and task notifications</li>
<li>Creates 2 HW ISR and ping/pong task is signaled from the ISR</li>
<li>Ping/Pong tasks increment a global ping/pong counter as well as a shared counter in between task switch</li>
</ul>
<p>Following tables summaries relevant memory map used by the example along with the static MPU regions configurations as well as the task specific MPU regions configurations,</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Memory Section  </th><th class="markdownTableHeadNone">Origin  </th><th class="markdownTableHeadNone">Size  </th><th class="markdownTableHeadNone">Static MPU Region Mapping  </th><th class="markdownTableHeadNone">Dynamic MPU Region Mapping   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">R5F_VECS  </td><td class="markdownTableBodyNone">0x00000000  </td><td class="markdownTableBodyNone">64 B  </td><td class="markdownTableBodyNone">[1]ATCM  </td><td class="markdownTableBodyNone">-   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">R5F_TCMA  </td><td class="markdownTableBodyNone">0x00000040  </td><td class="markdownTableBodyNone">31.9 KB  </td><td class="markdownTableBodyNone">[1]ATCM  </td><td class="markdownTableBodyNone">-   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">R5F_TCMB  </td><td class="markdownTableBodyNone">0x00080000  </td><td class="markdownTableBodyNone">32 KB  </td><td class="markdownTableBodyNone">[2]BTCM  </td><td class="markdownTableBodyNone">-   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">FLASH  </td><td class="markdownTableBodyNone">0x60100000  </td><td class="markdownTableBodyNone">512 KB  </td><td class="markdownTableBodyNone">[6]FLASH  </td><td class="markdownTableBodyNone">-   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SBL  </td><td class="markdownTableBodyNone">0x70000000  </td><td class="markdownTableBodyNone">256 KB  </td><td class="markdownTableBodyNone">[3]OCRAM_BACKGROUND  </td><td class="markdownTableBodyNone">-   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">OCRAM  </td><td class="markdownTableBodyNone">0x70040000  </td><td class="markdownTableBodyNone">128 KB  </td><td class="markdownTableBodyNone">[4]OCRAM_UNPRIVILEGED  </td><td class="markdownTableBodyNone">-   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">PRIVILEGED_TEXT  </td><td class="markdownTableBodyNone">0x70060000  </td><td class="markdownTableBodyNone">64 KB  </td><td class="markdownTableBodyNone">[5]OCRAM_PRIVILEGED_TEXT  </td><td class="markdownTableBodyNone">-   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">PRIVILEGED_DATA  </td><td class="markdownTableBodyNone">0x70070000  </td><td class="markdownTableBodyNone">56 KB  </td><td class="markdownTableBodyNone">[3]OCRAM_BACKGROUND  </td><td class="markdownTableBodyNone">[8]Ping/Pong Task Stack Region   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">PING_TEXT  </td><td class="markdownTableBodyNone">0x7007E000  </td><td class="markdownTableBodyNone">2 KB  </td><td class="markdownTableBodyNone">[3]OCRAM_BACKGROUND  </td><td class="markdownTableBodyNone">[9]Ping Task Region 0   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">PING_DATA  </td><td class="markdownTableBodyNone">0x7007E800  </td><td class="markdownTableBodyNone">2 KB  </td><td class="markdownTableBodyNone">[3]OCRAM_BACKGROUND  </td><td class="markdownTableBodyNone">[10]Ping Task Region 1   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">PONG_TEXT  </td><td class="markdownTableBodyNone">0x7007F000  </td><td class="markdownTableBodyNone">2 KB  </td><td class="markdownTableBodyNone">[3]OCRAM_BACKGROUND  </td><td class="markdownTableBodyNone">[9]Pong Task Region 0   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">PONG_DATA  </td><td class="markdownTableBodyNone">0x7007F800  </td><td class="markdownTableBodyNone">2 KB  </td><td class="markdownTableBodyNone">[3]OCRAM_BACKGROUND  </td><td class="markdownTableBodyNone">[10]Pong Task Region 1   </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">[idx]Static MPU Regions  </th><th class="markdownTableHeadNone">Base Address  </th><th class="markdownTableHeadNone">Size  </th><th class="markdownTableHeadNone">Execute  </th><th class="markdownTableHeadNone">Access Permissions   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">[0]BACKGROUND_REGION  </td><td class="markdownTableBodyNone">0x00000000  </td><td class="markdownTableBodyNone">2 GB  </td><td class="markdownTableBodyNone">No  </td><td class="markdownTableBodyNone">Supervisor RW, User RW   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">[1]ATCM  </td><td class="markdownTableBodyNone">0x00000000  </td><td class="markdownTableBodyNone">32 KB  </td><td class="markdownTableBodyNone">Yes  </td><td class="markdownTableBodyNone">Supervisor RW, User BLOCK   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">[2]BTCM  </td><td class="markdownTableBodyNone">0x00080000  </td><td class="markdownTableBodyNone">32 KB  </td><td class="markdownTableBodyNone">Yes  </td><td class="markdownTableBodyNone">Supervisor RW, User BLOCK   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">[3]OCRAM_BACKGROUND  </td><td class="markdownTableBodyNone">0x70000000  </td><td class="markdownTableBodyNone">2 MB  </td><td class="markdownTableBodyNone">No  </td><td class="markdownTableBodyNone">Supervisor RW, User BLOCK   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">[4]OCRAM_UNPRIVILEGED  </td><td class="markdownTableBodyNone">0x70040000  </td><td class="markdownTableBodyNone">128 KB  </td><td class="markdownTableBodyNone">Yes  </td><td class="markdownTableBodyNone">Supervisor RW, User RW   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">[5]OCRAM_PRIVILEGED_TEXT  </td><td class="markdownTableBodyNone">0x70060000  </td><td class="markdownTableBodyNone">64 KB  </td><td class="markdownTableBodyNone">Yes  </td><td class="markdownTableBodyNone">Supervisor RD, User BLOCK   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">[6]FLASH  </td><td class="markdownTableBodyNone">0x60100000  </td><td class="markdownTableBodyNone">512 KB  </td><td class="markdownTableBodyNone">Yes  </td><td class="markdownTableBodyNone">Supervisor RD, User BLOCK   </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">[idx]Ping/Pong Task MPU Regions  </th><th class="markdownTableHeadNone">Base Address  </th><th class="markdownTableHeadNone">Size  </th><th class="markdownTableHeadNone">Execute  </th><th class="markdownTableHeadNone">Access Permissions   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">[8]Stack Region  </td><td class="markdownTableBodyNone">-  </td><td class="markdownTableBodyNone">-  </td><td class="markdownTableBodyNone">No  </td><td class="markdownTableBodyNone">Supervisor RW, User RW   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">[9]PING_TEXT/PONG_TEXT  </td><td class="markdownTableBodyNone">0x7007E000/0x7007F000  </td><td class="markdownTableBodyNone">*2 KB  </td><td class="markdownTableBodyNone">Yes  </td><td class="markdownTableBodyNone">Supervisor RD, User RD   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">[10]PING_DATA/PONG_DATA  </td><td class="markdownTableBodyNone">0x7007E800/0x7007F800  </td><td class="markdownTableBodyNone">*2 KB  </td><td class="markdownTableBodyNone">No  </td><td class="markdownTableBodyNone">Supervisor RW, User RW   </td></tr>
</table>
<p>Note:</p><ul>
<li>[0]BACKGROUND_REGION with User RW access is required for peripheral access</li>
<li>[3]OCRAM_BACKGROUND maps entire OCRAM memory as Supervisor R/W only, restricting access by User<ul>
<li>Other overlay regions to give only the required access to user</li>
</ul>
</li>
<li>[8]Stack Region base address and size is dynamic<ul>
<li>MPU entry is added using the the stack buffer address and size</li>
</ul>
</li>
<li>[9]PING_TEXT/PONG_TEXT and [10]PING_DATA/PONG_DATA size is based on actual usage<ul>
<li>MPU entry is added using the linker script variables</li>
</ul>
</li>
</ul>
<p>The example source files are split to dedicated files to achieve following access restrictions,</p><ul>
<li>All text and data in <code>task_switch_mpu.c</code> is by default placed in privileged functions and privileged data sections respectively with following in linker script:- <div class="fragment"><div class="line">.text.task_switch_mpu.privileged : {</div>
<div class="line">    task_switch_mpu.obj(.text)</div>
<div class="line">} palign(8)</div>
<div class="line">} &gt; PRIVILEGED_TEXT       </div>
<div class="line"> </div>
<div class="line">.data.task_switch_mpu.privileged : {</div>
<div class="line">    task_switch_mpu.obj(.data, .bss)</div>
<div class="line">} palign(8)</div>
<div class="line">} &gt; PRIVILEGED_DATA </div>
</div><!-- fragment --> Hence user mode tasks won't have access to any of the text/data in <code>task_switch_mpu.c</code>. Ping/Pong task stacks are defined in <code>task_switch_mpu.c</code> and will be placed in privileged data section. But as part of user task creation a dedicated MPU region will be configured for the task stack. <br  />
</li>
<li>All text and data in <code>task_switch_mpu_ping.c</code> is by default placed in corresponding sections reserved for the ping task with the following in linker script:- <div class="fragment"><div class="line">GROUP  :   {</div>
<div class="line">.text.task_switch_mpu.ping : {</div>
<div class="line">    task_switch_mpu_ping.obj(.text)</div>
<div class="line">} palign(8)</div>
<div class="line">} &gt; PING_TEXT  </div>
<div class="line">RUN_START(__TEXT_PING_START)</div>
<div class="line">RUN_END(__TEXT_PING_END)</div>
<div class="line"> </div>
<div class="line">GROUP  :   {</div>
<div class="line">.data.task_switch_mpu.ping : {</div>
<div class="line">    task_switch_mpu_ping.obj(.data, .bss)</div>
<div class="line">} palign(8)</div>
<div class="line">} &gt; PING_DATA  </div>
<div class="line">RUN_START(__DATA_PING_START)</div>
<div class="line">RUN_END(__DATA_PING_END)</div>
</div><!-- fragment --> The linker variables <code>__TEXT_PING_START</code>, <code>__TEXT_PING_END</code>, <code>__DATA_PING_START</code>, <code>__DATA_PING_END</code> will be used to create the MPU regions for the ping task. Hence other user mode tasks won't have access to any of the text/data in <code>task_switch_mpu_ping.c</code>. <br  />
</li>
<li>All text and data in <code>task_switch_mpu_pong.c</code> is by default placed in corresponding sections reserved for the pong task with the following in linker script:- <div class="fragment"><div class="line">GROUP  :   {</div>
<div class="line">.text.task_switch_mpu.pong : {</div>
<div class="line">    task_switch_mpu_pong.obj(.text)</div>
<div class="line">} palign(8)</div>
<div class="line">} &gt; PONG_TEXT  </div>
<div class="line">RUN_START(__TEXT_PONG_START)</div>
<div class="line">RUN_END(__TEXT_PONG_END)</div>
<div class="line"> </div>
<div class="line">GROUP  :   {</div>
<div class="line">.data.task_switch_mpu.pong : {</div>
<div class="line">    task_switch_mpu_pong.obj(.data, .bss)</div>
<div class="line">} palign(8)</div>
<div class="line">} &gt; PONG_DATA  </div>
<div class="line">RUN_START(__DATA_PONG_START)</div>
<div class="line">RUN_END(__DATA_PONG_END)</div>
</div><!-- fragment --> The linker variables <code>__TEXT_PONG_START</code>, <code>__TEXT_PONG_END</code>, <code>__DATA_PONG_START</code>, <code>__DATA_PONG_END</code> will be used to create the MPU regions for the pong task. Hence other user mode tasks won't have access to any of the text/data in <code>task_switch_mpu_pong.c</code>. <br  />
</li>
<li>All text and data in <code>task_switch_mpu_common.c</code> is by default placed in generic text and data segments in OCRAM which falls under OCRAM_UNPRIVILEGED MPU region configuration. These will be accessible by user mode tasks unless explicitly specified by an attribute to place in a different dedicated section with reduced access permissions.<ul>
<li>Same is the case with SDK driver APIs and data.</li>
</ul>
</li>
<li>In summary,<ul>
<li>Any text/data which is not required by user mode tasks is placed in <code>task_switch_mpu.c</code></li>
<li>Any text/data which is required only by ping task is placed in <code>task_switch_mpu_ping.c</code></li>
<li>Any text/data which is required only by pong task is placed in <code>task_switch_mpu_pong.c</code></li>
<li>Any text/data which is required by both ping &amp; pong tasks is placed in <code>task_switch_mpu_common.c</code></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md1591"></a>
Supported Combinations</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CPU + OS  </td><td class="markdownTableBodyNone">r5fss0-0 freertos_mpu   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Toolchain  </td><td class="markdownTableBodyNone">ti-arm-clang   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Boards  </td><td class="markdownTableBodyNone">am263px-lp   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Example folder  </td><td class="markdownTableBodyNone">examples/kernel/freertos/task_switch_mpu   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1592"></a>
Steps to Run the Example</h1>
<ul>
<li><b>When using CCS projects to build</b>, import the CCS project for the required combination and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li><b>When using makefiles to build</b>, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
<li>Launch a CCS debug session and run the executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md1593"></a>
See Also</h1>
<p><a class="el" href="KERNEL_FREERTOS_PAGE.html">FreeRTOS</a></p>
<h1><a class="anchor" id="autotoc_md1594"></a>
Sample Output</h1>
<p>Shown below is a sample output when the application is run,</p>
<div class="fragment"><div class="line">FreeRTOS MPU Task Switch example ... start !!!</div>
<div class="line"> </div>
<div class="line">[FreeRTOS] ping task ... start !!!</div>
<div class="line"> </div>
<div class="line">Performing task switch using semaphores</div>
<div class="line"> </div>
<div class="line">pong count = 100000</div>
<div class="line">ping count = 100000</div>
<div class="line">common count = 200000</div>
<div class="line"> </div>
<div class="line">execution time for task switches = 1706467 us</div>
<div class="line">number of task switches = 200000 </div>
<div class="line">time per task switch (semaphore give/take) = 8532 ns</div>
<div class="line"> </div>
<div class="line">Performing task switch using direct-to-task notification</div>
<div class="line"> </div>
<div class="line">pong count = 100000</div>
<div class="line">ping count = 100000</div>
<div class="line">common count = 200000</div>
<div class="line"> </div>
<div class="line">execution time for task switches = 1509621 us</div>
<div class="line">number of task switches = 200000 </div>
<div class="line">time per task switch (direct-to-task notification give/take) = 7548 ns</div>
<div class="line"> </div>
<div class="line">Performing task switch using interrupts</div>
<div class="line"> </div>
<div class="line">pong count = 100000</div>
<div class="line">ping count = 100000</div>
<div class="line">common count = 200000</div>
<div class="line"> </div>
<div class="line">execution time for task - ISR - task - task switches = 1652114 us</div>
<div class="line">number of ISRs = 200000 </div>
<div class="line">time per task - ISR - task switch (semaphore give/take) = 8260 ns</div>
<div class="line"> </div>
<div class="line">[FreeRTOS] ping task ... done !!!</div>
<div class="line"> </div>
<div class="line">All tests have passed!!</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
