<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263Px MCU+ SDK: Optishare</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263Px MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263Px MCU+ SDK
   &#160;<span id="projectnumber">11.02.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('OPTIFLASH_OPTISHARE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Optishare </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md711">Introduction</a></li>
<li class="level1"><a href="#autotoc_md712">Optishare (Summary)</a></li>
<li class="level1"><a href="#autotoc_md713">Problem Statement</a></li>
<li class="level1"><a href="#autotoc_md714">OptiShare as a solution</a><ul><li class="level2"><a href="#autotoc_md715">Implementation</a><ul><li class="level3"><a href="#autotoc_md716">Compile time</a><ul><li class="level4"><a href="#autotoc_md717">To enable optishare in SDK example:</a></li>
<li class="level4"><a href="#autotoc_md718">To enable optishare in CCS</a></li>
</ul>
</li>
<li class="level3"><a href="#autotoc_md719">Runtime</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md720">How to Implement in a project</a><ul><li class="level2"><a href="#autotoc_md721">Build System Changes</a></li>
<li class="level2"><a href="#autotoc_md722">Memory Map Changes</a></li>
<li class="level2"><a href="#autotoc_md723">MPU settings</a></li>
<li class="level2"><a href="#autotoc_md724">Shared Memory Specification File (mem_spec.json)</a></li>
<li class="level2"><a href="#autotoc_md725">Code Changes</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md726">Performance Of OptiShare</a><ul><li class="level2"><a href="#autotoc_md727">Building MulticoreELF Binaries with Optishare</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md728">Final Remark</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_developer_guides_optishare_optishare"></a></p>
<h1><a class="anchor" id="autotoc_md711"></a>
Introduction</h1>
<p>This document goes over what is optishare and how it can be enabled in any project.</p>
<h1><a class="anchor" id="autotoc_md712"></a>
Optishare (Summary)</h1>
<p>The following image shows what optishare does at a very high level.</p>
<p> <style>div.image img[src="optishare_summary_1.png"]{width:40%}</style> </p><div class="image">
<img src="optishare_summary_1.png" alt=""/>
<div class="caption">
OptiShare Summary</div></div>
<p>As shown, optishare tool takes in input the application binary (ELF Format) for different cores and the output is binaries corresponding to each core and one additional binary called <code>shared object</code>. In the output, all the common function (text) and read-only data is removed each CPU binary and is placed in the <code>shared object</code>.</p>
<p><a class="el" href="EXAMPLES_DRIVERS_IPC_NOTIFY_ECHO_OPTISHARE.html">IPC Notify Echo Example With OptiShare</a> is an example in SDK which implements OptiShare.</p>
<h1><a class="anchor" id="autotoc_md713"></a>
Problem Statement</h1>
<ol type="1">
<li>AM2x devices are multicore devices.</li>
<li>when application is being built, each core is compiled separately.</li>
<li>Libraries are being linked statically in projects.</li>
</ol>
<p>In case when more than 2 core's projects are using same library, that library is kept more than once in memory and this cause wastage of memory.</p>
<h1><a class="anchor" id="autotoc_md714"></a>
OptiShare as a solution</h1>
<p>The solution here is to have a concept of "Shared" code/data.</p>
<p> <style>div.image img[src="optishare_solution_1.png"]{width:60%}</style> </p><div class="image">
<img src="optishare_solution_1.png" alt=""/>
<div class="caption">
Space Saving with Optishare</div></div>
<p>However, consider the following code:</p>
<div class="fragment"><div class="line">#define PmuP_SETUP_COUNTER_DIVIDER_VAL          (64ULL)</div>
<div class="line"> </div>
<div class="line">// global variable</div>
<div class="line">uint64_t gCounterFreqHz = 0;</div>
<div class="line"> </div>
<div class="line">void PMU_TEXT_SECTION CycleCounterP_init(const uint64_t cpuFreqHz)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    gCounterFreqHz = cpuFreqHz/PmuP_SETUP_COUNTER_DIVIDER_VAL;</div>
<div class="line"> </div>
<div class="line">    CycleCounterP_reset();</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><p>Assume this code is in all 4 cores. Now without optishare the address of the above variable is:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Symbol Address  </th><th class="markdownTableHeadNone">Core 0  </th><th class="markdownTableHeadNone">core 1  </th><th class="markdownTableHeadNone">Core 2  </th><th class="markdownTableHeadNone">Core 3   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">gCounterFreqHz  </td><td class="markdownTableBodyNone">0x7005cc78  </td><td class="markdownTableBodyNone">0x7008a1c0  </td><td class="markdownTableBodyNone">0x700ca1c0  </td><td class="markdownTableBodyNone">0x7010a1c0   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">CycleCounterP_init  </td><td class="markdownTableBodyNone">0x70054f84  </td><td class="markdownTableBodyNone">0x700866f8  </td><td class="markdownTableBodyNone">0x700c66f8  </td><td class="markdownTableBodyNone">0x701066f8   </td></tr>
</table>
<p>The Idea is to make the above function in just one location like 0x7007014c</p>
<p>However, there are some technical challenges with the above technique:</p>
<ol type="1">
<li>if CycleCounterP_initis placed just once and all 4 cores are accessing the same function then how does the function know which gCounterFreqHz variable to access? Should it access to gCounterFreqHz at 0x7005cc78 or 0x700ca1c0?</li>
<li>When CycleCounterP_init calls CycleCounterP_reset function, which core's CycleCounterP_reset function should be called?</li>
</ol>
<h2><a class="anchor" id="autotoc_md715"></a>
Implementation</h2>
<p>In ti-arm-clang, like GCC, basic units if layout are called "sections". Sections is a bytearray which cannot be split. Because sections are atomic units, therefore, if common functions are needed to be identified as shared functions, then a new section is required for each function (in GCC, -ffunction-section and -fdata-section are the flags that does this.). However, ti-arm-clang is by default making sections for each function and data, no extra function is required to be done.</p>
<p>There are 2 parts of optishare viz compile time and run time.</p>
<h3><a class="anchor" id="autotoc_md716"></a>
Compile time</h3>
<p>In this implementation, special flags are provided to the linker that makes it generate a .xml file. This XML file has</p>
<ol type="1">
<li>complete link info.</li>
<li>list of all function and their hash:<ol type="a">
<li>this XML file has a list of function, and a unique hash is associated with each function. This hash corresponds to the content of a function. If 2 functions have same hash, then it means that those 2 functions are same.</li>
</ol>
</li>
</ol>
<p> <style>div.image img[src="optishare_flow.png"]{width:100%}</style> </p><div class="image">
<img src="optishare_flow.png" alt=""/>
<div class="caption">
Optishare Flow</div></div>
<p>In the above diagram, the blocks that are of green color are the useable objects. The blocks that are colored as red should be discarded. In the bottom, it shows what are the <code>output binaries</code>.</p>
<p>To apply OptiShare in an existing project, it is required to</p>
<ol type="1">
<li>generate xml file by passing special flags &ndash;gen_xml_func_hash .</li>
<li>pass those xml files to optishare script.</li>
<li>link optishare script output to generate SSO.out</li>
<li>re-link project output ELF file again with SSO.out.</li>
</ol>
<p>In this implementation of optishare, Region Address Translation (RAT) hardware is being used.</p>
<p> <style>div.image img[src="optiflash_rat_.png"]{width:60%}</style> </p><div class="image">
<img src="optiflash_rat_.png" alt=""/>
<div class="caption">
RAT Hardware being used for Optishare</div></div>
<p>RAT hardware does the following functionality in this specific scenario:</p>
<div class="fragment"><div class="line">(Output Address) = (Input Address) + Offset </div>
</div><!-- fragment --><p>From the above flow, the output binaries that are generated by the optishare which is sso.out contains the shared text/data. Here text contains the functions.</p>
<p>When optishare script runs, it does the following:</p>
<ol type="1">
<li>Read all XML files</li>
<li>find all functions with common hash and mark them as potentially_shared</li>
<li>for all potentially_shared functions, if all function in callgraph of a potentially_shared function are also potentially_shared then mark that function as shared</li>
<li>To see the above algo in action, take example 1. That example calls <code>CycleCounterP_reset</code> function. This function is in the call graph of <code>CycleCounterP_init</code> function. So, from the above algo, <code>CycleCounterP_init</code> will only be marked as shared if <code>CycleCounterP_reset</code> is also shared across all cores. However, if <code>CycleCounterP_reset</code> itself is calling another function which is not being shared, then neither <code>CycleCounterP_reset</code> nor <code>CycleCounterP_init</code> will be shared. This basically means that entire call-graph of a function should be shared among all the cores to make a function shared.</li>
</ol>
<h4><a class="anchor" id="autotoc_md717"></a>
To enable optishare in SDK example:</h4>
<ol type="1">
<li><b>compilation with new flag</b>: If optishare is required to be applied, all cores are required to be built with -Wl,&ndash;gen_xml_func_hash and -Wl,&ndash;xml_link_info.</li>
<li><b>Run Optishare script</b>: Once there is linkxml file for all the cores, then optishare script will run on these linkxml files.</li>
<li><b>Relink example</b>: relink all the cores with the SSO file and this is done with a new linker flag -Wl,&ndash;import_sso.</li>
</ol>
<h4><a class="anchor" id="autotoc_md718"></a>
To enable optishare in CCS</h4>
<p>in .projectspec -Wl,&ndash;gen_xml_func_hash and -Wl,â€“xml_link_info flags should be present so that CCS is able to compile without any issues.</p>
<h3><a class="anchor" id="autotoc_md719"></a>
Runtime</h3>
<p>At runtime, optishare needs special hardware features.</p>
<p>The technical challenges that were previously highlighted is solved using virtual memory region. What this mean is that all the functions that are in sso.out will access <code>.data</code> and <code>.bss</code> from a virtual memory region. Now each core has its own RAT hardware. This RAT hardware will map this virtual memory region to a physical memory region that contains core specific data.</p>
<p> <style>div.image img[src="optishare_runtime.png"]{width:100%}</style> </p><div class="image">
<img src="optishare_runtime.png" alt=""/>
<div class="caption">
Optishare Runtime (Note that 0x100 is only taken as an example)</div></div>
<p>So, at runtime, each core will configure RAT that is associated to it, to map that virtual memory region to some physical memory address in SRAM.</p>
<p>However, using the above technique forces one more constraint on the layout. Suppose the shared code assumes the following layout of .data section:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Offset  </th><th class="markdownTableHeadNone">Symbol Name   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">var1   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">10  </td><td class="markdownTableBodyNone">var2   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">12  </td><td class="markdownTableBodyNone">var3   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">22  </td><td class="markdownTableBodyNone">var4   </td></tr>
</table>
<p>Now because RAT hardware is simply translating the address, each core should have same offset of var1 to var4. <br  />
</p>
<h1><a class="anchor" id="autotoc_md720"></a>
How to Implement in a project</h1>
<p>Here <a class="el" href="EXAMPLES_DRIVERS_IPC_NOTIFY_ECHO_OPTISHARE.html">IPC Notify Echo Example With OptiShare</a> example is being used.</p>
<h2><a class="anchor" id="autotoc_md721"></a>
Build System Changes</h2>
<p>As previously written, add new flags to generate xml file. The following images shows the additional linker flag that is be added for each core compilation.</p>
<p> <style>div.image img[src="optishare_link_flags.png"]{width:40%}</style> </p><div class="image">
<img src="optishare_link_flags.png" alt=""/>
<div class="caption">
Optishare link time flags</div></div>
<p>This flag will generate .lnkxml file. This XML will have all the link information in XML format.</p>
<p>Other than this, add new rule that links the appliation again but with <code>--import_sso</code> flag.</p>
<p> <style>div.image img[src="coreout_rule.png"]{width:100%}</style> </p><div class="image">
<img src="coreout_rule.png" alt=""/>
<div class="caption">
Relinking of binary</div></div>
<h2><a class="anchor" id="autotoc_md722"></a>
Memory Map Changes</h2>
<p>Each core's linker file needs to be changed.</p>
<p>For AM263Px, last 512KB of the memory is being used as the shared memory of Optishare.</p>
<div class="fragment"><div class="line">C0_SSO_LCL   : ORIGIN = 0x70280000 , LENGTH = 0x8000</div>
<div class="line"> </div>
<div class="line">C1_SSO_LCL   : ORIGIN = 0x70288000 , LENGTH = 0x8000 </div>
<div class="line"> </div>
<div class="line">C2_SSO_LCL   : ORIGIN = 0x70290000 , LENGTH = 0x8000 </div>
<div class="line"> </div>
<div class="line">C3_SSO_LCL   : ORIGIN = 0x70298000 , LENGTH = 0x8000 </div>
<div class="line"> </div>
<div class="line">SSO_SHM   : ORIGIN = 0x702A0000 , LENGTH = 0x8000 </div>
<div class="line"> </div>
<div class="line">USER_SHM   : ORIGIN = 0x702A8000 , LENGTH = 0x58000 </div>
</div><!-- fragment --><p>This looks as follows:</p>
<p> <style>div.image img[src="shared_memory_map.png"]{width:40%}</style> </p><div class="image">
<img src="shared_memory_map.png" alt=""/>
<div class="caption">
Memory Map of Shared Region</div></div>
<p>Here</p><ol type="1">
<li><b>C0_SSO_LCL</b> is the physical memory for Core 0 of the shared code's virtual memory.</li>
<li><b>SSO_SHM</b> is where the actual shared code be placed.</li>
<li><b>USER_SHM</b> is the general purpose shared memory for the user application.</li>
</ol>
<p>in the <code>SECTION</code> of linker of core 0, add the following as is:</p>
<div class="fragment"><div class="line">.shared.text  : {</div>
<div class="line">} &gt; C0_SSO_LCL   , palign(4096) </div>
<div class="line"> </div>
<div class="line">.shared.rodata  : {</div>
<div class="line">} &gt; C0_SSO_LCL   , palign(4096) </div>
<div class="line"> </div>
<div class="line">.shared.data  : {</div>
<div class="line">} &gt; C0_SSO_LCL   , palign(4096) </div>
<div class="line"> </div>
<div class="line">.shared.bss  : {</div>
<div class="line">} &gt; C0_SSO_LCL   , palign(4096) </div>
</div><!-- fragment --><p>For core 1, memory section would be <code>C1_SSO_LCL</code> and so on.</p>
<h2><a class="anchor" id="autotoc_md723"></a>
MPU settings</h2>
<p>For this memory region, make sure that each core is marking this 512KB of L2 memory as shared in MPU.</p>
<p>The following images shows the same:</p>
<p> <style>div.image img[src="shared_memory_memory.png"]{width:40%}</style> </p><div class="image">
<img src="shared_memory_memory.png" alt=""/>
<div class="caption">
MPU Of Shared Region</div></div>
<p>Selecting <code>Non-Cached</code> will make that region as the <code>shared</code>.</p>
<p>The reason why Cx_SSO_LCL needs to be non-cached is because, the data that is in this region is mostly some global variables. When Shared code updates that global variable, it sends out a virtual address and then RAT in effects updates the physical memory address. However, if caches are on, then, this would cause in-coherency issue.</p>
<h2><a class="anchor" id="autotoc_md724"></a>
Shared Memory Specification File (mem_spec.json)</h2>
<p>Optishare script runs, in this example, its cmd is:</p>
<div class="fragment"><div class="line">node &lt;compiler path&gt;/opti-share/opti-share.js </div>
<div class="line">-o sso.cmd.tmp </div>
<div class="line">../r5fss0-0_freertos/ti-arm-clang/ipc_notify_echo_optishare.release.lnkxml </div>
<div class="line">../r5fss0-1_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.lnkxml </div>
<div class="line">../r5fss1-0_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.lnkxml</div>
<div class="line">../r5fss1-1_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.lnkxml  </div>
<div class="line">-s sso.info.tmp</div>
<div class="line">--mem_spec optishare_memmap.json</div>
</div><!-- fragment --><p>Notice the <code>--mem_spec</code> flag. This flag is sued to pass in the memory specification to the optishare script. This is because, optishare script as of now cannot deduce the shared memory region. That is why, it is required to send out explicit shared memory specifications.</p>
<p>In this example, it is being defined as.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;mem_spec&quot;:</div>
<div class="line">    {</div>
<div class="line">        &quot;device_mem_regions&quot; : [</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot;: &quot;OCRAM&quot;,</div>
<div class="line">                &quot;origin&quot;: &quot;0x70000000&quot;,</div>
<div class="line">                &quot;length&quot;: &quot;0x300000&quot;,</div>
<div class="line">                &quot;kind&quot;:&quot;system&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot;: &quot;FLASH&quot;,</div>
<div class="line">                &quot;origin&quot;: &quot;0x60000000&quot;,</div>
<div class="line">                &quot;length&quot;: &quot;0x8000000&quot;,</div>
<div class="line">                &quot;kind&quot;:&quot;system&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot;: &quot;TCMA&quot;,</div>
<div class="line">                &quot;origin&quot;: &quot;0x0&quot;,</div>
<div class="line">                &quot;length&quot;: &quot;0x8000&quot;,</div>
<div class="line">                &quot;kind&quot;:&quot;local&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot;: &quot;TCMB&quot;,</div>
<div class="line">                &quot;origin&quot;: &quot;0x80000&quot;,</div>
<div class="line">                &quot;length&quot;: &quot;0x8000&quot;,</div>
<div class="line">                &quot;kind&quot;:&quot;local&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot;: &quot;CUSTOM&quot;,</div>
<div class="line">                &quot;origin&quot;: &quot;0x0&quot;,</div>
<div class="line">                &quot;length&quot;: &quot;0xffffffff&quot;,</div>
<div class="line">                &quot;kind&quot;:&quot;system&quot;</div>
<div class="line">            }</div>
<div class="line">        ],</div>
<div class="line">        &quot;shared_mem_regions&quot; : [</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot; : &quot;SSO_SHM_RX&quot;,</div>
<div class="line">                &quot;origin&quot; : &quot;0x702A0000&quot;,</div>
<div class="line">                &quot;length&quot; : &quot;0x3000&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot; : &quot;SSO_SHM_RO&quot;,</div>
<div class="line">                &quot;origin&quot; : &quot;0x702A3000&quot;,</div>
<div class="line">                &quot;length&quot; : &quot;0x1000&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot; : &quot;SSO_SHM_RW&quot;,</div>
<div class="line">                &quot;origin&quot; : &quot;0x702A4000&quot;,</div>
<div class="line">                &quot;length&quot; : &quot;0x4000&quot;</div>
<div class="line">            }</div>
<div class="line">        ],</div>
<div class="line">        &quot;shared_os_placement_instrs&quot; : [</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot; : &quot;.shared.text&quot;,</div>
<div class="line">                &quot;placement&quot; : &quot;&gt; SSO_SHM_RX, palign(4096)&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot; : &quot;.shared.rodata&quot;,</div>
<div class="line">                &quot;placement&quot; : &quot;&gt; SSO_SHM_RO, palign(4096)&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot; : &quot;.shared.bss&quot;,</div>
<div class="line">                &quot;placement&quot; : &quot;&gt; SSO_SHM_RW, palign(4096)&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot; : &quot;.shared.data&quot;,</div>
<div class="line">                &quot;placement&quot; : &quot;&gt; SSO_SHM_RW, palign(4096)&quot;</div>
<div class="line">            }</div>
<div class="line">        ]</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><code>device_mem_regions</code> is the general information of different memories available in a device. For any device, <code>device_mem_regions</code> struct should be same as given here.</p>
<p><code>shared_mem_regions</code> contains the shared memory specification. Here it splits the <code>SSO_SHM</code> into different region. This is <b>important</b>, as it is required to split it into RX, RO and RW sections and <code>.shared.bss</code> and <code>.shared.data</code> should be placed only in the RW section. <br  />
</p>
<p><code>shared_os_placement_instrs</code> is specifying the section placement. This should not be changed and kept as is.</p>
<p>The only change is required for <code>shared_mem_regions</code>.</p>
<h2><a class="anchor" id="autotoc_md725"></a>
Code Changes</h2>
<p>C Code needs to be changed as presented as follows:</p>
<p> <style>div.image img[src="runtime_code_changes_blockdiagram.png"]{width:40%}</style> </p><div class="image">
<img src="runtime_code_changes_blockdiagram.png" alt=""/>
<div class="caption">
Run time code changes block diagram</div></div>
<p>As mentioned above, before enabling optishare (which is programming RAT), application should make sure that all the function and their called global variables should not be shared. This can be made sure by adding in <code>do_not_share</code> attribute to a function:</p>
<div class="fragment"><div class="line">void __attribute__((do_not_share)) AddrTranslateP_init (AddrTranslateP_Params *params);</div>
</div><!-- fragment --><p>When, code is relinked with <code>--import_sso</code> flag, linker generates some symbols which can be used to program RAT. The following code shows how to do that:</p>
<div class="fragment"><div class="line">/*</div>
<div class="line">Following symbols are linker generated symbols</div>
<div class="line">*/</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion0_src_addr;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion0_trg_addr;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion0_region_sz;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion1_src_addr;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion1_trg_addr;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion1_region_sz;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion2_src_addr;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion2_trg_addr;</div>
<div class="line"> </div>
<div class="line">extern int __TI_ATRegion2_region_sz;</div>
<div class="line"> </div>
<div class="line">__attribute__((do_not_share)) int main(void)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    AddrTranslateP_Params params;</div>
<div class="line">    AddrTranslateP_RegionConfig region[3];</div>
<div class="line"> </div>
<div class="line">    AddrTranslateP_Params_init(&amp;params);</div>
<div class="line"> </div>
<div class="line">    if((uint32_t)(&amp;__TI_ATRegion0_region_sz) &gt; 0)</div>
<div class="line">    {</div>
<div class="line">        params.numRegions++;</div>
<div class="line">        region[0].size = 0;</div>
<div class="line">        uint32_t actualSize = (uint32_t)(&amp;__TI_ATRegion0_region_sz);</div>
<div class="line">        region[0].localAddr = (uint32_t)&amp;__TI_ATRegion0_src_addr;</div>
<div class="line">        region[0].systemAddr = (uint32_t)&amp;__TI_ATRegion0_trg_addr;</div>
<div class="line">        for(uint32_t sz = 1; sz &lt; actualSize; region[0].size++)</div>
<div class="line">        {</div>
<div class="line">            sz = sz &lt;&lt; 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    if((uint32_t)(&amp;__TI_ATRegion1_region_sz) &gt; 0)</div>
<div class="line">    {</div>
<div class="line">        params.numRegions++;</div>
<div class="line">        region[1].size = 0;</div>
<div class="line">        region[1].localAddr = (uint32_t)&amp;__TI_ATRegion1_src_addr;</div>
<div class="line">        region[1].systemAddr = (uint32_t)&amp;__TI_ATRegion1_trg_addr;</div>
<div class="line">        for(uint32_t sz = 1; sz &lt; (uint32_t)(&amp;__TI_ATRegion1_region_sz); sz &lt;&lt;= 1, region[1].size++);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    if((uint32_t)(&amp;__TI_ATRegion2_region_sz) &gt; 0)</div>
<div class="line">    {</div>
<div class="line">        params.numRegions++;</div>
<div class="line">        region[2].size = 0;</div>
<div class="line">        region[2].localAddr = (uint32_t)&amp;__TI_ATRegion2_src_addr;</div>
<div class="line">        region[2].systemAddr = (uint32_t)&amp;__TI_ATRegion2_trg_addr;</div>
<div class="line">        for(uint32_t sz = 1; sz &lt; (uint32_t)(&amp;__TI_ATRegion2_region_sz); sz &lt;&lt;= 1, region[2].size++);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    params.ratBaseAddr = CSL_RL2_REGS_R5SS0_CORE0_U_BASE + CSL_RL2_OF_R5FSS0_CORE0_RAT_CTL(0) - 0x20;</div>
<div class="line">    params.regionConfig = region;</div>
<div class="line">    AddrTranslateP_init(&amp;params);</div>
<div class="line"> </div>
<div class="line">    return AppStart();</div>
<div class="line">}</div>
</div><!-- fragment --><p>In the above code, it programs the RAT before starting the application.</p>
<h1><a class="anchor" id="autotoc_md726"></a>
Performance Of OptiShare</h1>
<p>Compiler comes with another program that does the shows the saving of memory that is able to be achieved. <br  />
</p>
<div class="fragment"><div class="line">node &lt;compiler-path&gt;/opti-share/utils/opti-save.js ../r5fss0-0_freertos/ti-arm-clang/ipc_notify_echo_optishare.release.lnkxml ../r5fss0-0_freertos/ti-arm-clang/ipc_notify_echo_optishare.release.optishare.lnkxml &gt; ../r5fss0-0_freertos/ti-arm-clang/ipc_notify_echo_optishare.release.ossr</div>
</div><!-- fragment --><p>The above command compares the link-xml of application when compiled before optishare and after optishare.</p>
<p>the output is a text file which in this case is a file with extension <code>*.ossr</code> (OptiShare Savings Report).</p>
<p>The contents of looks like the following:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Section  </th><th class="markdownTableHeadNone">ipc_notify_echo_optishare.release.lnkxml  </th><th class="markdownTableHeadNone">ipc_notify_echo_optishare.release.optishare.lnkxml  </th><th class="markdownTableHeadNone">Saving   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">.text.hwi  </td><td class="markdownTableBodyNone">2472  </td><td class="markdownTableBodyNone">2360  </td><td class="markdownTableBodyNone">112   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">.text.cache  </td><td class="markdownTableBodyNone">1072  </td><td class="markdownTableBodyNone">240  </td><td class="markdownTableBodyNone">832   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">.text.mpu  </td><td class="markdownTableBodyNone">520  </td><td class="markdownTableBodyNone">400  </td><td class="markdownTableBodyNone">120   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">.text.boot  </td><td class="markdownTableBodyNone">392  </td><td class="markdownTableBodyNone">368  </td><td class="markdownTableBodyNone">24   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">.text:abort  </td><td class="markdownTableBodyNone">8  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">8   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">.text  </td><td class="markdownTableBodyNone">30256  </td><td class="markdownTableBodyNone">28496  </td><td class="markdownTableBodyNone">1760   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">.rodata  </td><td class="markdownTableBodyNone">5856  </td><td class="markdownTableBodyNone">5152  </td><td class="markdownTableBodyNone">704   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">.data  </td><td class="markdownTableBodyNone">1000  </td><td class="markdownTableBodyNone">688  </td><td class="markdownTableBodyNone">312   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">.bss.log_shared_mem  </td><td class="markdownTableBodyNone">16384  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">16384   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">.shared.data  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">4096  </td><td class="markdownTableBodyNone">-4096   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">.shared.bss  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">12288  </td><td class="markdownTableBodyNone">-12288   </td></tr>
</table>
<p>The above is for core R5F0-0. Run the above script for each core to get the total savings for each core.</p>
<h2><a class="anchor" id="autotoc_md727"></a>
Building MulticoreELF Binaries with Optishare</h2>
<p>MulticcoreELF (<a class="el" href="MCELF_LANDING.html">Understanding Multicore ELF image format</a>) is image format that SDK use to boot from flash. tools/boot/multicore-elf/genimage.py is the python script that takes in input <code>.out</code> file of cores and then provides <code>.mcelf</code> and <code>.mcelf_xip</code> as the output. The command looks like the follwing when optishare is not enabled:</p>
<div class="fragment"><div class="line">python3 /home/sanmveg/ti/workarea/mcu_plus_sdk/tools/boot/multicore-elf/genimage.py  </div>
<div class="line">--core-img=0:../r5fss0-0_freertos/ti-arm-clang/ipc_notify_echo_optishare.release.out </div>
<div class="line">--core-img=1:../r5fss0-1_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.out </div>
<div class="line">--core-img=2:../r5fss1-0_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.out </div>
<div class="line">--core-img=3:../r5fss1-1_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.out </div>
<div class="line">--output=ipc_notify_echo_optishare_system.release.mcelf --merge-segments=true --tolerance-limit=0 </div>
<div class="line">--ignore-context=false --xip=0x60000000:0x68000000 --xlat=&quot;&quot; --max_segment_size=8192 </div>
</div><!-- fragment --><p>To enable optishare, &ndash;sso flag is to be passed.</p>
<div class="fragment"><div class="line">python3 &lt;sdkPath&gt;/tools/boot/multicore-elf/genimage.py  </div>
<div class="line">--core-img=0:../r5fss0-0_freertos/ti-arm-clang/ipc_notify_echo_optishare.release.optishare.out </div>
<div class="line">--core-img=1:../r5fss0-1_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.optishare.out</div>
<div class="line">--core-img=2:../r5fss1-0_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.optishare.out </div>
<div class="line">--core-img=3:../r5fss1-1_nortos/ti-arm-clang/ipc_notify_echo_optishare.release.optishare.out </div>
<div class="line">--output=ipc_notify_echo_optishare_system.release.optishare.mcelf </div>
<div class="line">--merge-segments=true --tolerance-limit=0 --ignore-context=false --xip=0x60000000:0x68000000 </div>
<div class="line">--xlat=&quot;&quot; </div>
<div class="line">--max_segment_size=8192 </div>
<div class="line">--sso=sso.out</div>
</div><!-- fragment --><p><code>sso.out</code> contains the shared code and data.</p>
<h1><a class="anchor" id="autotoc_md728"></a>
Final Remark</h1>
<p>Implementation of optishare is bit complex as it requires some understanding of linkers, ARM Memory Protection Unit (MPU), ARM Assembly Addressing Model , SOC level address translation using RAT, Caches etc. However, if implemented correctly, it can lead of a lot of memory savings. In usecase, where there are 2 OS running on different cores, this would make almost all the OS code as shared and leaving more space for user application. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
