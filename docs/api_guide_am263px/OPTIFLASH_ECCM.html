<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM263Px MCU+ SDK: Enabling safety on external flash</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="AM263Px MCU+ SDK"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM263Px MCU+ SDK
   &#160;<span id="projectnumber">11.01.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.html" method="get">
              <img id="MSearchSelect" src="search/mag.svg" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('OPTIFLASH_ECCM.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Enabling safety on external flash </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md663">Introduction</a></li>
<li class="level1"><a href="#autotoc_md664">How to enable ECCM module</a><ul><li class="level2"><a href="#autotoc_md665">Write a config file</a></li>
<li class="level2"><a href="#autotoc_md666">Using the config file</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md667">Additional details</a><ul><li class="level2"><a href="#autotoc_md668">ECCM Module</a></li>
<li class="level2"><a href="#autotoc_md669">Important considerations</a></li>
<li class="level2"><a href="#autotoc_md670">Seeing the change</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_developer_guides_optiflash_eccm_optiflash_eccm"></a></p>
<h1><a class="anchor" id="autotoc_md663"></a>
Introduction</h1>
<p>Unlike NAND flash, which has <code>spare area</code> for storing ECC of <code>main area</code>, NOR flash do not have such provision. NOR flash in AM26x devices are also being used to perform XIP as well.</p>
<p>This Page goes over how safety can be enabled on external NOR flash in AM26x devices which also use NOR flash for XIP.</p>
<h1><a class="anchor" id="autotoc_md664"></a>
How to enable ECCM module</h1>
<h2><a class="anchor" id="autotoc_md665"></a>
Write a config file</h2>
<p>The following is an example of a config file (conf.json)</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;regions&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;start&quot;: &quot;0x60100000&quot;,</div>
<div class="line">            &quot;size&quot;: &quot;0x400000&quot;,     </div>
<div class="line">            &quot;cryptoMode&quot;:&quot;na&quot;,</div>
<div class="line">            &quot;eccEnable&quot;: true</div>
<div class="line">        }</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>There can be at most 4 different ECC regions that can be configured. The above shows 1 region. For example, in am263px, there are 4 different core and each core can have its own region configured. Make sure that each region is not overlaping each other.</p>
<p>In the above, region start address is 0x60100000 and size 4MB.</p>
<h2><a class="anchor" id="autotoc_md666"></a>
Using the config file</h2>
<p>The example <a class="el" href="BENCHMARK_SMART_PLACEMENT.html">Memory Benchmark with Smart Placement</a> uses XIP and for the sake of demostration, it is being used.</p>
<p>While compiling the application, pass in the argument <code>oeconfig=conf.json</code>.</p>
<p>For example, if current working directory is <code>MCU_PLUS_SDK_PATH</code>, the following command will process the flash contents for ECC.</p>
<div class="fragment"><div class="line">gmake -C .\examples\benchmarks\ocmc_benchmarking\am263px-cc\system_tri_core\ oeconfig=conf.json</div>
</div><!-- fragment --><p>for Linux machine, <code>gmake</code> will be replaced by <code>make</code>.</p>
<h1><a class="anchor" id="autotoc_md667"></a>
Additional details</h1>
<h2><a class="anchor" id="autotoc_md668"></a>
ECCM Module</h2>
<p>The following diagram shows</p>
<p> <style>div.image img[src="am263px_safety_io_highlight.png"]{width:40%}</style> </p><div class="image">
<img src="am263px_safety_io_highlight.png" alt=""/>
<div class="caption">
ECC Module</div></div>
<p>As can be seen, it sits just before the <code>Flash controller</code> and operates between the data that is coming from the flash and then process it on the fly.</p>
<p>ECCM module works on the bases on inlining of ECC Bytes of data. As per the datasheet of ECCM, it expects 4B of ECC data after every 32B of actual data (As per the below iamge)</p>
<p> <style>div.image img[src="eccm_padding.png"]{width:40%}</style> </p><div class="image">
<img src="eccm_padding.png" alt=""/>
<div class="caption">
ECC Padding To Data Byte</div></div>
<p>Here the requestor, R5F with cache enabled for the external flash, sends request for the data from the flash. R5F sends a request to get 32B of data from the external flash and this request goes via the ECCM, which then ask <code>flash controller</code> to get 36B of data. When the <code>flash controller</code> sends back the request 36B of data, ECCM module,</p><ol type="1">
<li>strips off the 4B of ECC data</li>
<li>calculates the ECC of 1st 32B of data</li>
<li>compares the computed ECC with extracted ECC bytes <br  />
</li>
</ol>
<p>If computed ECC and saved ECC matches, ECCM forwards the data to the requestor, otherwise, it sends 0 and puts up an interrupt to the requestor, indicating that data fault has been detected.</p>
<h2><a class="anchor" id="autotoc_md669"></a>
Important considerations</h2>
<ol type="1">
<li>Flash region should be defined as <code>Normal &amp; Cached</code> in the MPU.</li>
<li>As can be seen, for every 32B, there is 4B of ECC. Because of this, the available size of flash is decreased and as per datasheet, size of flash is decreaed by ~11.11%. During the architecture phase of the software, one has to consider this fact. If the software requirement is to enable ECC on external flash, then, the size of the external flash should be reduced in linker file, etc. For example if 8mb of external flash is being used, then sofware/user applicaiton should only use 7mb of flash.</li>
<li>Writing to flash with ECCM enabled should be avoided at all cost. Harware does not supports it. The right way to do this is to pre-compute ECC for the data that is to be written to flash and write the computed data via the flsopskd controller (<a class="el" href="FLSOPSKD_IP.html">How to use Flash Operation Scheduler Hardware</a>). (or write to external flash via <code>bypass region</code>).</li>
</ol>
<h2><a class="anchor" id="autotoc_md670"></a>
Seeing the change</h2>
<p>To see if the processing has been done correctly, use the command</p>
<p><code>tiarmreadelf --headers app_name.mcelf_xip</code></p>
<dl class="section note"><dt>Note</dt><dd><code>tiarmreadelf</code> is part of tiarmclang toolchain. Make sure toolchain bin path is added in the environment path.</dd></dl>
<p>For the processed code, output will be the following:</p>
<div class="fragment"><div class="line">Program Headers:</div>
<div class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</div>
<div class="line">  NOTE           0x0000b4 0x00000000 0x00000000 0x000f0 0x000f0     0x0</div>
<div class="line">  LOAD           0x0001a4 0x60360000 0x60360000 0x120000 0x120000 RW  0x1000</div>
<div class="line">  LOAD           0x1201a4 0x60510000 0x60510000 0x120000 0x120000 RW  0x1000</div>
<div class="line">  LOAD           0x2401a4 0x606c0000 0x606c0000 0x120000 0x120000 RW  0x1000</div>
</div><!-- fragment --><p>Without processing, it looks like the following:</p>
<div class="fragment"><div class="line">Program Headers:</div>
<div class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</div>
<div class="line">  NOTE           0x0000b4 0x00000000 0x00000000 0x00080 0x00080     0x0</div>
<div class="line">  LOAD           0x000134 0x60300000 0x60300000 0x100000 0x100000 RW  0x1000</div>
<div class="line">  LOAD           0x100134 0x60480000 0x60480000 0x100000 0x100000 RW  0x1000</div>
<div class="line">  LOAD           0x200134 0x60600000 0x60600000 0x100000 0x100000 RW  0x1000</div>
</div><!-- fragment --><p>on comparing the original program, the segment's address (VirtAddr and PhysAddr) have changed. Earlier, they were 0x60300000, 0x60480000, 0x60600000. Because for every 32B, 4B of ECC has been added, each segment size has been increased from 1MB to 1.125MB and same has happen to address. <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
